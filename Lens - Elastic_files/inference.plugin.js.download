/*! Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one or more contributor license agreements.
 * Licensed under the Elastic License 2.0; you may not use this file except in compliance with the Elastic License 2.0. */(()=>{var e={777:(e,t,r)=>{"use strict";r.r(t),r.d(t,{getDefaultConnector:()=>k,plugin:()=>_});var n=r(915);let o=function(e){return e.User="user",e.Assistant="assistant",e.Tool="tool",e}({});const i=__kbnSharedDeps__.Rxjs;let a=function(e){return e.ChatCompletionChunk="chatCompletionChunk",e.ChatCompletionTokenCount="chatCompletionTokenCount",e.ChatCompletionMessage="chatCompletionMessage",e}({}),l=function(e){return e.OutputUpdate="output",e.OutputComplete="complete",e}({});__kbnSharedDeps__.KbnI18n;let s=function(e){return e.error="error",e.data="data",e}({});class ServerSentEventError extends Error{constructor(e,t,r){super(t),this.code=e,this.meta=r}get status(){if("object"==typeof this.meta&&this.meta.status)return this.meta.status}toJSON(){return{type:s.error,error:{code:this.code,message:this.message,meta:this.meta}}}}let u=function(e){return e.providerError="providerError",e.internalError="internalError",e.requestError="requestError",e.abortedError="requestAborted",e}({});const c=ServerSentEventError;function d(e="An internal error occurred",t){return new c(u.internalError,e,null!=t?t:{})}function f(e){return e instanceof c}let p=function(e){return e.TokenLimitReachedError="tokenLimitReachedError",e.ToolNotFoundError="toolNotFoundError",e.ToolValidationError="toolValidationError",e}({});function m(e){return e instanceof c&&e.code===p.ToolValidationError}function h(e){return function t({id:r,connectorId:n,input:s,schema:u,system:c,previousMessages:d,modelName:f,functionCalling:p,stream:h,abortSignal:g,maxRetries:v,retryConfiguration:y,metadata:b,retry:C}){if(h&&void 0!==C)throw new Error("Retry options are not supported in streaming mode");const E=function(e){const t=[];return e.forEach((e=>{const r=function(e,t){return e?e.role===o.User&&t.role===o.User?{roleSequenceValid:!1,intermediaryRole:o.Assistant}:e.role===o.Assistant&&t.role===o.Assistant?{roleSequenceValid:!1,intermediaryRole:o.User}:(e.role===o.Tool&&(t.role,o.Tool),{roleSequenceValid:!0}):{roleSequenceValid:!0}}(t[t.length-1],e);if(!r.roleSequenceValid){const e="-";t.push((r.intermediaryRole,o.User,{content:e,role:r.intermediaryRole}))}t.push(e)})),t}([...d||[],{role:o.User,content:s}]),w=e({connectorId:n,stream:h,modelName:f,functionCalling:p,abortSignal:g,maxRetries:v,retryConfiguration:y,metadata:b,system:c,messages:E,...u?{tools:{structuredOutput:{description:"Use the following schema to respond to the user's request in structured data, so it can be parsed and handled.",schema:u}},toolChoice:{function:"structuredOutput"}}:{}});return(0,i.isObservable)(w)?w.pipe((0,i.filter)((e=>e.type!==a.ChatCompletionTokenCount)),(0,i.map)((e=>{var t,n,o,i;return e.type===a.ChatCompletionChunk?{type:l.OutputUpdate,id:r,content:e.content}:{id:r,output:null!=e&&null!==(t=e.toolCalls)&&void 0!==t&&t.length&&"arguments"in(null==e||null===(n=e.toolCalls[0])||void 0===n?void 0:n.function)?null===(o=e.toolCalls[0])||void 0===o||null===(i=o.function)||void 0===i?void 0:i.arguments:void 0,content:e.content,type:l.OutputComplete}}))):w.then((e=>{var t,n,o,i;return{id:r,content:e.content,output:null!=e&&null!==(t=e.toolCalls)&&void 0!==t&&t.length&&"arguments"in(null==e||null===(n=e.toolCalls[0])||void 0===n?void 0:n.function)?null==e||null===(o=e.toolCalls[0])||void 0===o||null===(i=o.function)||void 0===i?void 0:i.arguments:void 0}}),(e=>{if(m(e)&&null!=C&&C.onValidationError){var i,a,l;const d="number"==typeof C.onValidationError?C.onValidationError:1;return t({id:r,connectorId:n,input:s,schema:u,system:c,abortSignal:g,previousMessages:E.concat({role:o.Assistant,content:"",toolCalls:null===(i=e.meta.toolCalls)||void 0===i?void 0:i.map((e=>({...e,function:{...e.function,arguments:JSON.parse(e.function.arguments)}})))},...null!==(a=null===(l=e.meta.toolCalls)||void 0===l?void 0:l.map((t=>({name:t.function.name,role:o.Tool,toolCallId:t.toolCallId,response:{error:e.meta}}))))&&void 0!==a?a:[]),functionCalling:p,modelName:f,stream:!1,retry:{onValidationError:d-1}})}throw e}))}}const g=[400,401,402,403,404,405,406,407,409],v=()=>!0,y=e=>{if(m(e))return!0;if(f(t=e)&&t.code===u.abortedError)return!0;var t;if(function(e){return f(e)&&e.code===u.providerError}(e)){const t=e.status;return!t||!g.includes(t)}return!1},b=(e="auto")=>"function"==typeof e?e:"all"===e?v:y;function C(e,t){if(!t)return e;const r=new AbortController;return null==e||e.addEventListener("abort",(()=>{r.abort()})),null==t||t.addEventListener("abort",(()=>{r.abort()})),r.signal}let E=function(e){return e.error="error",e}({});class ParseError extends Error{constructor(e,t){super(e),this.name="ParseError",this.type=t.type,this.field=t.field,this.value=t.value,this.line=t.line}}function w(e){}function S(){return(0,i.pipe)((0,i.switchMap)((e=>function(e){const t=e.response,r=null==t?void 0:t.body;return r?new i.Observable((e=>{const t=function(e){if("function"==typeof e)throw new TypeError("`callbacks` must be an object, got a function instead. Did you mean `{onEvent: fn}`?");const{onEvent:t=w,onError:r=w,onRetry:n=w,onComment:o}=e;let i,a="",l=!0,s="",u="";function c(e){if(""===e)return s.length>0&&t({id:i,event:u||void 0,data:s.endsWith("\n")?s.slice(0,-1):s}),i=void 0,s="",void(u="");if(e.startsWith(":"))return void(o&&o(e.slice(e.startsWith(": ")?2:1)));const r=e.indexOf(":");if(-1===r)d(e,"",e);else{const t=e.slice(0,r),n=" "===e[r+1]?2:1;d(t,e.slice(r+n),e)}}function d(e,t,o){switch(e){case"event":u=t;break;case"data":s=`${s}${t}\n`;break;case"id":i=t.includes("\0")?void 0:t;break;case"retry":/^\d+$/.test(t)?n(parseInt(t,10)):r(new ParseError(`Invalid \`retry\` value: "${t}"`,{type:"invalid-retry",value:t,line:o}));break;default:r(new ParseError(`Unknown field "${e.length>20?`${e.slice(0,20)}â€¦`:e}"`,{type:"unknown-field",field:e,value:t,line:o}))}}return{feed:function(e){const t=l?e.replace(/^\xEF\xBB\xBF/,""):e,[r,n]=function(e){const t=[];let r="",n=0;for(;n<e.length;){const o=e.indexOf("\r",n),i=e.indexOf("\n",n);let a=-1;if(-1!==o&&-1!==i?a=Math.min(o,i):-1!==o?a=o===e.length-1?-1:o:-1!==i&&(a=i),-1===a){r=e.slice(n);break}{const r=e.slice(n,a);t.push(r),n=a+1,"\r"===e[n-1]&&"\n"===e[n]&&n++}}return[t,r]}(`${a}${t}`);for(const e of r)c(e);a=n,l=!1},reset:function(e={}){a&&e.consume&&c(a),l=!0,i=void 0,s="",u="",a=""}}}({onEvent:t=>{e.next(t.data)}});(async()=>{const e=r.getReader(),n=new TextDecoder,o=({done:r,value:i})=>r?Promise.resolve():(t.feed(n.decode(i,{stream:!0})),e.read().then(o));return e.read().then(o)})().then((()=>{e.complete()})).catch((t=>{e.error(t)}))})):(0,i.throwError)((()=>{throw d("No readable stream found in response")}))}(e))),(0,i.catchError)((e=>(0,i.throwError)((()=>d(e.message))))),(0,i.map)((e=>{try{return JSON.parse(e)}catch(e){throw d("Failed to parse JSON")}})),(0,i.tap)((e=>{if(e.type===E.error){const t=e;throw new c(t.error.code,t.error.message,t.error.meta)}})))}class InferencePlugin{constructor(e){(0,n.default)(this,"logger",void 0),this.logger=e.logger.get()}setup(e,t){return{}}start(e,t){const r=function({fetch:e,signal:t}){return({connectorId:r,messages:n,system:o,toolChoice:a,tools:l,temperature:s,modelName:u,functionCalling:c,stream:d,abortSignal:f,maxRetries:p,metadata:m,retryConfiguration:h})=>{const g={connectorId:r,system:o,messages:n,toolChoice:a,tools:l,temperature:s,modelName:u,functionCalling:c,retryConfiguration:void 0,maxRetries:p,metadata:m};function v(){return function({maxRetry:e=3,initialDelay:t=1e3,backoffMultiplier:r=2,errorFilter:n=()=>!0}){return(0,i.retry)({count:e,delay:(e,o)=>{if(!n(e))throw e;const a=t*Math.pow(r,o-1);return(0,i.timer)(a)}})}({maxRetry:p,backoffMultiplier:null==h?void 0:h.backoffMultiplier,errorFilter:b(null==h?void 0:h.retryOn),initialDelay:null==h?void 0:h.initialDelay})}return d?(0,i.from)(e("/internal/inference/chat_complete/stream",{method:"POST",asResponse:!0,rawResponse:!0,body:JSON.stringify(g),signal:C(t,f)})).pipe(S(),v()):(0,i.lastValueFrom)((0,i.defer)((()=>e("/internal/inference/chat_complete",{method:"POST",body:JSON.stringify(g),signal:C(t,f)}))).pipe(v()))}}({fetch:e.http.fetch});return{chatComplete:r,output:h(r),getConnectors:async()=>(await e.http.get("/internal/inference/connectors")).connectors}}}let O=function(e){return e.OpenAI=".gen-ai",e.Bedrock=".bedrock",e.Gemini=".gemini",e.Inference=".inference",e}({});Object.values(O);const k=({connectors:e})=>{const t=e.find((e=>e.type===O.Inference));if(t)return t;return e.find((e=>e.type===O.OpenAI))||e[0]},_=e=>new InferencePlugin(e)},352:(e,t,r)=>{r.p=window.__kbnPublicPath__.inference},915:(e,t,r)=>{e.exports=r(497)(67493)},497:e=>{"use strict";e.exports=__kbnSharedDeps_npm__}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");if(n.length)for(var o=n.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=n[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),r.p=e})(),r(352),__kbnBundles__.define("plugin/inference/public",r,777)})();